<!DOCTYPE html>
<html lang="he" dir="rtl" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <title>yedaarechevAI – הדשבורד שלי</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap"
          rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#EC4899',
                        dark: '#0F172A',
                        'dark-lighter': '#1E293B'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Heebo', system-ui, -apple-system, sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fadeInOverlay {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .overlay-open {
            animation: fadeInOverlay 0.25s ease-out;
        }
    </style>
</head>
<body class="bg-dark text-slate-200 min-h-screen flex flex-col antialiased">

<header class="sticky top-0 z-40 bg-dark/90 backdrop-blur-lg border-b border-slate-800/80">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <a href="{{ url_for('public.index') }}" class="flex items-center">
            <h1 class="text-xl md:text-2xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-primary via-purple-500 to-secondary">
                yedaarechevAI
            </h1>
        </a>

        <div class="flex items-center gap-3 text-sm font-medium">
            {% if user and user.is_authenticated %}
                <span class="text-slate-400 hidden sm:inline">
                    {{ user.name.split(' ')[0] if user.name else 'אורח' }}
                </span>
                
                <!-- בודק אמינות (Reliability Checker) -->
                <a href="{{ url_for('public.index') }}"
                   class="px-4 py-1.5 rounded-full bg-slate-800/80 hover:bg-slate-700 text-white border border-slate-700/50 transition-all text-sm"
                   title="בודק אמינות רכבים">
                    בודק אמינות
                </a>
                
                <!-- השוואת רכבים -->
                <a href="{{ url_for('comparison.compare_page') }}"
                   class="px-4 py-1.5 rounded-full bg-slate-800/80 hover:bg-slate-700 text-white border border-slate-700/50 transition-all text-sm"
                   title="השוואת רכבים">
                    השוואה
                </a>
                
                <a href="{{ url_for('public.logout') }}"
                   class="p-2 rounded-full text-slate-300 hover:bg-white/10"
                   title="התנתקות">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-6 w-6"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0
                              01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                </a>
            {% else %}
                <a href="{{ url_for('public.login') }}"
                   class="px-4 py-1.5 rounded-full bg-primary text-white text-sm font-bold">
                    התחברות
                </a>
            {% endif %}
        </div>
    </div>
</header>

<main class="flex-grow relative container mx-auto px-4 py-8 pb-24">

    <div class="mb-8">
        <h2 class="text-2xl md:text-3xl font-extrabold text-white mb-2">
            החיפושים שלי
        </h2>

        {% if history_error %}
            <div class="mb-4 p-3 rounded-lg bg-amber-900/40 border border-amber-700 text-amber-200 text-sm">
                {{ history_error }}
            </div>
        {% endif %}

        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
            <button type="button" onclick="showTab('reliability')" id="tab-reliability"
                    class="tab-btn whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-800 text-slate-100 border border-slate-600 cursor-pointer transition-colors">
                היסטוריית בדיקות אמינות
            </button>
            <button type="button" onclick="showTab('comparisons')" id="tab-comparisons"
                    class="tab-btn whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-900/50 text-slate-500 border border-slate-700/50 cursor-pointer transition-colors hover:bg-slate-800 hover:text-slate-300">
                השוואות
            </button>
            <span class="whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-900/50 text-slate-500 border border-slate-700/50">
                היסטוריית המלצות (בקרוב · {{ advisor_count or 0 }} שאלונים)
            </span>
            <button type="button" onclick="showTab('leasing')" id="tab-leasing"
                    class="tab-btn whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-900/50 text-slate-500 border border-slate-700/50 cursor-pointer transition-colors hover:bg-slate-800 hover:text-slate-300">
                יועץ ליסינג ({{ leasing_history|default([])|length }})
            </button>
            <button type="button" onclick="showTab('service_prices')" id="tab-service_prices"
                    class="tab-btn whitespace-nowrap px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-900/50 text-slate-500 border border-slate-700/50 cursor-pointer transition-colors hover:bg-slate-800 hover:text-slate-300">
                בדיקת מחירי טיפול
            </button>
        </div>
    </div>

    <!-- Reliability History Tab -->
    <div id="tab-content-reliability" class="relative z-10">
        {% if searches and searches|length > 0 %}
            <div class="grid gap-4">
                {% for s in searches %}
                    <article
                        class="bg-dark-lighter/80 border border-slate-700/60 rounded-xl p-4 active:scale-[0.98] transition-transform cursor-pointer shadow-lg"
                        data-search-id="{{ s.id }}"
                        onclick="openDetails('{{ s.id }}')"
                    >
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                    {{ s.make|title }} {{ s.model|title }}
                                    <span class="text-primary text-base font-normal">
                                        {{ s.year }}
                                    </span>
                                    {% if s.data.get('reliability_report') %}
                                        <span class="text-[10px] px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-500/40">כולל דוח</span>
                                    {% endif %}
                                </h3>

                                <div class="flex flex-wrap items-center gap-2 mt-1 text-[11px] text-slate-400">
                                    <span>{{ s.timestamp }}</span>

                                    {% if s.mileage_range %}
                                        <span>•</span>
                                        <span>ק״מ: {{ s.mileage_range }}</span>
                                    {% endif %}

                                    {% if s.fuel_type %}
                                        <span>•</span>
                                        <span>{{ s.fuel_type }}</span>
                                    {% endif %}

                                    {% if s.transmission %}
                                        <span>•</span>
                                        <span>{{ s.transmission }}</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if s.data.get('estimated_reliability') %}
                                <div class="flex flex-col items-end gap-1">
                                    <div class="text-sm font-bold text-emerald-200">
                                        אמינות מוערכת: {{ s.data.get('estimated_reliability') }}
                                    </div>
                                    <div class="text-[10px] text-slate-400">
                                        מבוסס על ניתוח AI
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12 bg-dark-lighter/40 rounded-2xl border border-slate-800">
                <p class="text-slate-400 mb-4">
                    אין היסטוריה עדיין.
                </p>
                <a href="{{ url_for('public.index') }}"
                   class="px-6 py-2 rounded-full bg-primary text-white font-bold text-sm">
                    התחל בדיקה
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Comparisons History Tab -->
    <div id="tab-content-comparisons" class="relative z-10 hidden">
        <div id="comparisons-list" class="grid gap-4">
            <div class="text-center py-8 text-slate-400">טוען היסטוריית השוואות...</div>
        </div>
    </div>

    <!-- Service Prices History Tab -->
    <div id="tab-content-service_prices" class="relative z-10 hidden">
        <div id="service-prices-list" class="grid gap-4">
            <div class="text-center py-8 text-slate-400">טוען היסטוריית בדיקות מחירים...</div>
        </div>
    </div>

    <!-- Leasing Advisor History Tab -->
    <div id="tab-content-leasing" class="relative z-10 hidden">
        {% if leasing_history and leasing_history|length > 0 %}
        <div class="grid gap-4">
            {% for lh in leasing_history %}
            <article class="bg-dark-lighter/80 border border-slate-700/60 rounded-xl p-4 shadow-lg">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-white">{{ lh.top_recommendation or 'יועץ ליסינג' }}</h3>
                        <p class="text-sm text-slate-400 mt-1">{{ lh.frame_summary }}</p>
                    </div>
                    <span class="text-xs text-slate-500">{{ lh.created_at }}</span>
                </div>
                {% if lh.duration_ms %}
                <span class="text-xs text-slate-500 mt-2 block">⏱️ {{ lh.duration_ms }}ms</span>
                {% endif %}
            </article>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <p class="text-slate-400 text-lg">עדיין אין היסטוריית יועץ ליסינג</p>
            <a href="/leasing" class="mt-4 inline-block px-6 py-2 rounded-xl bg-primary/20 text-primary font-bold hover:bg-primary/30 transition">התחל שימוש ביועץ ליסינג</a>
        </div>
        {% endif %}
    </div>

    <!-- Delete Account Section -->
    <div class="mt-12 pt-8 border-t border-slate-800">
        <div class="bg-dark-lighter/50 border border-red-900/30 rounded-xl p-6">
            <h3 class="text-lg font-bold text-white mb-2">מחיקת חשבון</h3>
            <p class="text-slate-400 text-sm mb-4">
                מחיקת החשבון תסיר לצמיתות את כל הנתונים שלך, כולל היסטוריית חיפושים ושאלונים. פעולה זו אינה הפיכה.
            </p>
            <button 
                onclick="openDeleteModal()"
                class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">
                מחק חשבון לצמיתות
            </button>
        </div>
    </div>

</main>

<!-- Delete Account Modal -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onclick="closeDeleteModal(event)">
    <div class="bg-dark-lighter border-2 border-red-600/50 rounded-2xl p-8 max-w-md w-full overlay-open" onclick="event.stopPropagation()">
        <h3 class="text-2xl font-bold text-white mb-4">אישור מחיקת חשבון</h3>
        <p class="text-slate-300 mb-6">
            פעולה זו תמחק לצמיתות את החשבון שלך וכל הנתונים הקשורים אליו.
            <strong class="text-red-400">אין דרך לשחזר את הנתונים לאחר המחיקה.</strong>
        </p>
        <p class="text-slate-300 mb-4">
            כדי לאשר, הקלד <strong class="text-red-400">DELETE</strong> בדיוק (באנגלית, באותיות גדולות):
        </p>
        <input 
            type="text" 
            id="deleteConfirmInput"
            placeholder="הקלד DELETE"
            class="w-full px-4 py-3 bg-slate-900 border-2 border-slate-700 focus:border-red-500 rounded-lg text-white mb-2"
            onkeypress="if(event.key==='Enter') confirmDelete()"
        />
        <p id="deleteError" class="text-red-400 text-sm mb-4 hidden"></p>
        
        <div class="flex gap-3">
            <button 
                onclick="confirmDelete()"
                id="deleteConfirmButton"
                class="flex-1 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors">
                אשר מחיקה
            </button>
            <button 
                onclick="closeDeleteModal()"
                class="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-lg transition-colors">
                ביטול
            </button>
        </div>
    </div>
</div>

<div id="details-overlay"
     class="fixed inset-0 bg-dark/95 z-50 hidden flex flex-col overlay-open">
    <div class="flex items-center justify-between px-4 py-3 bg-dark-lighter border-b border-slate-700 shrink-0 shadow-md">
        <div>
            <h3 id="details-title"
                class="text-lg md:text-xl font-bold text-white leading-tight">
                </h3>
            <p id="details-meta"
               class="text-xs text-slate-400 mt-0.5">
                </p>
        </div>
        <button id="details-close-btn"
                class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-800 text-white border border-slate-600 active:bg-slate-700"
                type="button"
                aria-label="סגירה">
            ✕
        </button>
    </div>

    <div id="details-content"
         class="flex-1 overflow-y-auto overflow-x-hidden bg-dark px-4 py-4 md:px-6 md:py-6 relative">
        </div>
</div>

<script>
    const overlayEl = document.getElementById('details-overlay');
    const detailsTitleEl = document.getElementById('details-title');
    const detailsMetaEl = document.getElementById('details-meta');
    const detailsContentEl = document.getElementById('details-content');
    const detailsCloseBtn = document.getElementById('details-close-btn');

    function escapeHtml(value) {
        const div = document.createElement('div');
        div.textContent = value == null ? '' : String(value);
        return div.innerHTML;
    }

    async function openDetails(searchId) {
        if (!searchId) return;

        if (detailsContentEl) {
            detailsContentEl.innerHTML =
                '<div class="text-center py-8 text-sm text-slate-400">טוען נתונים...</div>';
        }

        overlayEl.classList.remove('hidden');
        document.body.style.overflow = 'hidden';

        const showError = (message = 'שגיאה בטעינת הנתונים.') => {
            if (!detailsContentEl) return;
            detailsContentEl.innerHTML =
                `<div class="text-center py-8 text-sm text-red-400">${escapeHtml(message)}</div>`;
        };
        const extractErrorMessage = (rawError, fallback = 'שגיאה בטעינת הנתונים.') => {
            if (typeof rawError === 'string') return rawError;
            if (rawError && rawError.message) return rawError.message;
            return fallback;
        };
        try {
            const response = await fetch(`/search-details/${searchId}`, {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            });

            const contentType = (response.headers.get('content-type') || '').toLowerCase();
            let payload;
            if (contentType.includes('application/json')) {
                payload = await response.json();
            } else {
                throw new Error(`Unexpected content-type: ${contentType || 'unknown'}`);
            }

            const rawError = payload && payload.error;
            if (!response.ok) {
                const msg = extractErrorMessage(rawError, response.statusText || 'שגיאה בטעינת הנתונים.');
                showError(msg);
                return;
            }

            if (payload && payload.ok === false) {
                const msg = extractErrorMessage(rawError);
                showError(msg);
                return;
            }

            // API contract: { ok: true, data: { meta: {...}, data: {...} } }
            const payloadData = payload && payload.data;
            const meta = payloadData && payloadData.meta;
            const details = payloadData && payloadData.data;
            if (!payloadData || !meta || !details) {
                showError('נתוני חיפוש חסרים.');
                return;
            }
            renderDetails(meta, details);
        } catch (err) {
            console.error(err);
            showError();
        }
    }

    function closeDetails() {
        overlayEl.classList.add('hidden');
        document.body.style.overflow = '';
    }

    if (detailsCloseBtn) {
        detailsCloseBtn.addEventListener('click', closeDetails);
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !overlayEl.classList.contains('hidden')) {
            closeDetails();
        }
    });

    function safeNumber(val, decimals = 1) {
        const n = Number(val);
        if (Number.isNaN(n)) return '';
        return n.toFixed(decimals);
    }

    function renderDetails(meta, data) {
        if (!meta || !data) return;

        const titleParts = [];
        if (meta.make) titleParts.push(meta.make);
        if (meta.model) titleParts.push(meta.model);
        const title = titleParts.join(' ') || 'רכב';

        const yearStr = meta.year ? ` · ${meta.year}` : '';
        detailsTitleEl.textContent = title + yearStr;

        const metaBits = [];
        if (meta.timestamp) metaBits.push(meta.timestamp);
        if (meta.mileage_range) metaBits.push(`ק״מ: ${meta.mileage_range}`);
        if (meta.fuel_type) metaBits.push(meta.fuel_type);
        if (meta.transmission) metaBits.push(meta.transmission);

        detailsMetaEl.textContent = metaBits.join(' • ');

        const baseScore = data.base_score_calculated;
        const baseScoreText = baseScore !== undefined && baseScore !== null
            ? safeNumber(baseScore, 1)
            : null;

        const scoreBreakdown = data.score_breakdown || {};
        const simpleSummary = data.reliability_summary_simple || '';
        const fullSummary = data.reliability_summary || '';
        const mileageNote = data.mileage_note || null;
        const avgRepair = data.avg_repair_cost_ILS;
        const issues = Array.isArray(data.common_issues) ? data.common_issues : [];
        const issuesWithCosts = Array.isArray(data.issues_with_costs) ? data.issues_with_costs : [];
        const sources = Array.isArray(data.sources) ? data.sources : [];
        const checks = Array.isArray(data.recommended_checks) ? data.recommended_checks : [];
        const competitors = Array.isArray(data.common_competitors_brief) ? data.common_competitors_brief : [];
        const sourceTag = data.source_tag || '';
        const reliabilityReport = data.reliability_report || {};

        let baseColor = 'text-slate-100';
        const baseNum = Number(baseScore);
        if (!Number.isNaN(baseNum)) {
            if (baseNum >= 80) baseColor = 'text-emerald-400';
            else if (baseNum >= 60) baseColor = 'text-amber-400';
            else baseColor = 'text-rose-400';
        }

        let breakdownRows = '';
        const labels = {
            engine_transmission_score: 'מנוע + גיר',
            electrical_score: 'מערכת חשמל',
            suspension_brakes_score: 'מתלים + ברקסים',
            maintenance_cost_score: 'עלות תחזוקה',
            satisfaction_score: 'שביעות רצון בעלי רכב',
            recalls_score: 'קריאות תיקון'
        };
        Object.keys(labels).forEach(key => {
            if (scoreBreakdown[key] === undefined || scoreBreakdown[key] === null) return;
            const val = safeNumber(scoreBreakdown[key], 1);
            breakdownRows += `
                <tr class="border-b border-slate-800/80">
                    <td class="px-3 py-2 text-xs text-slate-300">${labels[key]}</td>
                    <td class="px-3 py-2 text-xs font-semibold text-slate-100">${val}</td>
                </tr>
            `;
        });

        let issuesListHtml = '';
        if (issues.length) {
            issuesListHtml = `
                <ul class="list-disc pr-5 space-y-1 text-xs text-slate-100">
                    ${issues.map(i => `<li>${i}</li>`).join('')}
                </ul>
            `;
        }

        let issuesCostsHtml = '';
        if (issuesWithCosts.length) {
            issuesCostsHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full text-right border-separate border-spacing-y-1 text-xs">
                        <thead class="text-[11px] text-slate-400">
                            <tr>
                                <th class="px-2 py-1 font-semibold">תקלה</th>
                                <th class="px-2 py-1 font-semibold">עלות ממוצעת (₪)</th>
                                <th class="px-2 py-1 font-semibold">חומרה</th>
                                <th class="px-2 py-1 font-semibold">מקור</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${issuesWithCosts.map(it => `
                                <tr class="border-b border-slate-800/80">
                                    <td class="px-2 py-1 text-slate-100">${it.issue || ''}</td>
                                    <td class="px-2 py-1 text-slate-100">${it.avg_cost_ILS || ''}</td>
                                    <td class="px-2 py-1 text-slate-100">${it.severity || ''}</td>
                                    <td class="px-2 py-1 text-slate-300 text-[11px]">${it.source || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        let sourcesHtml = '';
        if (sources.length) {
            sourcesHtml = `
                <ul class="list-disc pr-5 space-y-1 text-xs text-slate-300">
                    ${sources.map(s => `<li>${s}</li>`).join('')}
                </ul>
            `;
        }

        let checksHtml = '';
        if (checks.length) {
            checksHtml = `
                <ul class="list-disc pr-5 space-y-1 text-xs text-slate-100">
                    ${checks.map(c => `<li>${c}</li>`).join('')}
                </ul>
            `;
        }

        let competitorsHtml = '';
        if (competitors.length) {
            competitorsHtml = `
                <ul class="list-disc pr-5 space-y-1 text-xs text-slate-300">
                    ${competitors.map(c => `
                        <li>
                            <span class="font-semibold text-slate-100">${c.model || ''}:</span>
                            <span>${c.brief_summary || ''}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }

        let reportHtml = '';
        if (reliabilityReport && reliabilityReport.available === false) {
            reportHtml = '<p class="text-xs text-slate-400">דוח אמינות לא זמין (MISSING_OR_INVALID).</p>';
        } else if (Object.keys(reliabilityReport).length) {
            const risks = Array.isArray(reliabilityReport.top_risks) ? reliabilityReport.top_risks : [];
            const checklist = reliabilityReport.buyer_checklist || {};
            reportHtml = `
                <div class="space-y-2 text-xs text-slate-200">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-white">ציון דוח:</span>
                        <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">${escapeHtml(reliabilityReport.overall_score || '')}</span>
                        <span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">ביטחון: ${escapeHtml(reliabilityReport.confidence || '')}</span>
                    </div>
                    <p class="text-slate-100">${escapeHtml(reliabilityReport.one_sentence_verdict || '')}</p>
                    <div>
                        <div class="font-semibold text-slate-100 mb-1">סיכונים מרכזיים</div>
                        <ul class="list-disc pr-4 space-y-1">
                            ${risks.map(r => `<li>${escapeHtml(r.risk_title || '')} – ${escapeHtml(r.why_it_matters || '')}</li>`).join('') || '<li class="text-slate-400">אין סיכונים מפורטים.</li>'}
                        </ul>
                    </div>
                    <div>
                        <div class="font-semibold text-slate-100 mb-1">שאלות למוכר</div>
                        <ul class="list-disc pr-4 space-y-1">
                            ${(checklist.ask_seller || []).map(x => `<li>${escapeHtml(x)}</li>`).join('') || '<li class="text-slate-400">אין מידע</li>'}
                        </ul>
                    </div>
                </div>
            `;
        } else {
            reportHtml = '<p class="text-xs text-slate-400">דוח אמינות לא נשלח עבור חיפוש זה.</p>';
        }

        const avgRepairHtml = avgRepair !== undefined && avgRepair !== null
            ? `<div class="text-xs text-slate-300 mt-2">
                   עלות תיקון ממוצעת: <span class="font-semibold text-slate-100">${safeNumber(avgRepair, 0)} ₪</span>
               </div>`
            : '';

        const mileageNoteHtml = mileageNote
            ? `<div class="mt-2 text-[11px] text-amber-300">
                   <span class="font-bold">אזהרה:</span> ${mileageNote}
               </div>`
            : '';

        const sourceTagHtml = sourceTag
            ? `<div class="mt-4 text-[11px] text-slate-500 border-t border-slate-800 pt-2">
                   ${sourceTag}
               </div>`
            : '';

        const simpleSummaryHtml = simpleSummary
            ? `<p class="text-sm text-slate-100 leading-relaxed whitespace-pre-line">${simpleSummary}</p>`
            : '<p class="text-sm text-slate-400">אין סיכום פשוט זמין.</p>';

        const fullSummaryHtml = fullSummary
            ? `<p class="text-sm text-slate-200 leading-relaxed whitespace-pre-line">${fullSummary}</p>`
            : '<p class="text-sm text-slate-400">אין סיכום מקצועי זמין.</p>';

        // --- NEW BUTTONS NAVIGATION (MODIFIED SECTION) ---
        const navButtons = `
          <div class="sticky top-0 z-30 bg-dark/95 backdrop-blur py-3 border-b border-slate-700/50 mb-6 flex gap-2 overflow-x-auto no-scrollbar -mx-4 px-4">
              <button onclick="document.getElementById('sec-competitors').scrollIntoView({behavior: 'smooth'})" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-2 text-xs text-slate-200 transition-colors shrink-0">
                  <span>מתחרים</span> <span class="bg-orange-500 text-white rounded px-1 text-[10px] font-bold">VS</span>
              </button>
              <button onclick="document.getElementById('sec-costs').scrollIntoView({behavior: 'smooth'})" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-2 text-xs text-slate-200 transition-colors shrink-0">
                  <span>עלויות</span>
              </button>
              <button onclick="document.getElementById('sec-issues').scrollIntoView({behavior: 'smooth'})" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-2 text-xs text-slate-200 transition-colors shrink-0">
                  <span>תקלות</span>
              </button>
              <button onclick="document.getElementById('sec-summary').scrollIntoView({behavior: 'smooth'})" class="px-3 py-1.5 bg-slate-600/80 border-b-2 border-primary text-white rounded-t flex items-center gap-2 text-xs transition-colors shrink-0">
                 <span>סיכום</span>
              </button>
               <button onclick="document.getElementById('sec-sources').scrollIntoView({behavior: 'smooth'})" class="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-2 text-xs text-slate-200 transition-colors shrink-0">
                  <span>מקורות</span> <span class="text-slate-400">קישור</span>
              </button>
          </div>
        `;

        detailsContentEl.innerHTML = `
            ${navButtons}

            <section class="bg-dark-lighter/80 border border-slate-700 rounded-2xl p-4 mb-4">
                <div class="flex items-center justify-between gap-4">
                    <div>
                        <div class="text-xs font-semibold text-slate-400 mb-1">
                            אמינות מוערכת: ${data.estimated_reliability || 'לא ידוע'}
                        </div>
                        <div class="text-[11px] text-slate-400 mb-1">
                            מבוסס על ניתוח AI
                        </div>
                        ${mileageNoteHtml}
                    </div>
                </div>
            </section>

            <section id="sec-summary" class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-2 scroll-mt-32">
                <h4 class="text-sm font-bold text-slate-100">
                    סיכום פשוט לנהג שלא מבין ברכבים
                </h4>
                ${simpleSummaryHtml}
            </section>

            <section id="sec-costs" class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-3 scroll-mt-32">
                <h4 class="text-sm font-bold text-slate-100">
                    פירוט ציונים ועלויות
                </h4>
                ${breakdownRows
                    ? `<div class="overflow-x-auto">
                           <table class="min-w-[260px] text-right border-separate border-spacing-y-1 text-xs">
                               <tbody>${breakdownRows}</tbody>
                           </table>
                       </div>`
                    : '<p class="text-xs text-slate-400">אין פירוט ציונים זמין.</p>'
                }
                ${avgRepairHtml}
            </section>

            <section id="sec-issues" class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-3 scroll-mt-32">
                <h4 class="text-sm font-bold text-slate-100">
                    תקלות נפוצות ועלויות משוערות
                </h4>
                ${issuesListHtml || '<p class="text-xs text-slate-400">אין רשימת תקלות מפורטת.</p>'}
                ${issuesCostsHtml}
            </section>

            <section class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-2">
                <h4 class="text-sm font-bold text-slate-100">
                    סיכום מקצועי מפורט
                </h4>
                ${fullSummaryHtml}
            </section>

            <section class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-2">
                <h4 class="text-sm font-bold text-slate-100">
                    מה חשוב לבדוק לפני סגירת עסקה
                </h4>
                ${checksHtml || '<p class="text-xs text-slate-400">אין רשימת בדיקות ייעודית.</p>'}
            </section>

            <section id="sec-competitors" class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-2 scroll-mt-32">
                <h4 class="text-sm font-bold text-slate-100">
                    מתחרים באותה קטגוריה
                </h4>
                ${competitorsHtml || '<p class="text-xs text-slate-400">אין רשימת מתחרים.</p>'}
            </section>

            <section class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-2 scroll-mt-32">
                <h4 class="text-sm font-bold text-slate-100">
                    דוח אמינות מורחב
                </h4>
                ${reportHtml}
            </section>

            <section id="sec-sources" class="bg-dark-lighter/70 border border-slate-800 rounded-2xl p-4 space-y-2 mb-4 scroll-mt-32">
                <h4 class="text-sm font-bold text-slate-100">
                    מקורות מידע
                </h4>
                ${sourcesHtml || '<p class="text-xs text-slate-400">המודל לא החזיר רשימת מקורות.</p>'}
                ${sourceTagHtml}
            </section>
        `;
    }

    // Delete account modal functions
    function openDeleteModal() {
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteConfirmInput').value = '';
        document.getElementById('deleteError').classList.add('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeDeleteModal(event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById('deleteModal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    async function confirmDelete() {
        const input = document.getElementById('deleteConfirmInput');
        const errorEl = document.getElementById('deleteError');
        const confirmBtn = document.getElementById('deleteConfirmButton');
        const confirmValue = input.value.trim();
        
        if (confirmValue !== 'DELETE') {
            errorEl.textContent = 'נדרש להקליד DELETE בדיוק (באנגלית, באותיות גדולות)';
            errorEl.classList.remove('hidden');
            return;
        }
        
        errorEl.classList.add('hidden');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.classList.add('opacity-70', 'cursor-not-allowed');
        }
        
        try {
            const response = await fetch('/api/account/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Cache-Control': 'no-store',
                },
                credentials: 'include',
                body: JSON.stringify({ confirm: 'DELETE' })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Success - redirect to home page
                alert('החשבון נמחק בהצלחה');
                window.location.href = '/';
            } else {
                const message = (data && (data.error?.message || data.error)) || data.message || 'שגיאה במחיקת החשבון';
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            }
        } catch (error) {
            errorEl.textContent = 'שגיאת רשת - נסה שוב';
            errorEl.classList.remove('hidden');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }
    }

    // ============================================================
    // TAB SWITCHING & COMPARISON HISTORY
    // ============================================================
    
    let currentTab = 'reliability';
    let comparisonsLoaded = false;
    
    function showTab(tabName) {
        currentTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-slate-800', 'text-slate-100', 'border-slate-600');
            btn.classList.add('bg-slate-900/50', 'text-slate-500', 'border-slate-700/50');
        });
        const activeBtn = document.getElementById(`tab-${tabName}`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-slate-900/50', 'text-slate-500', 'border-slate-700/50');
            activeBtn.classList.add('bg-slate-800', 'text-slate-100', 'border-slate-600');
        }
        
        // Show/hide content
        document.getElementById('tab-content-reliability').classList.toggle('hidden', tabName !== 'reliability');
        document.getElementById('tab-content-comparisons').classList.toggle('hidden', tabName !== 'comparisons');
        document.getElementById('tab-content-service_prices').classList.toggle('hidden', tabName !== 'service_prices');
        document.getElementById('tab-content-leasing').classList.toggle('hidden', tabName !== 'leasing');
        
        // Load comparisons if switching to that tab for the first time
        if (tabName === 'comparisons' && !comparisonsLoaded) {
            loadComparisonsHistory();
        }
        // Load service prices history if switching to that tab
        if (tabName === 'service_prices') {
            loadServicePricesHistory();
        }
    }
    
    async function loadServicePricesHistory() {
        const container = document.getElementById('service-prices-list');
        try {
            const response = await fetch('/api/service-prices/history?per_page=20', {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            });
            const data = await response.json();
            if (!response.ok || !data.ok) {
                container.innerHTML = `<div class="text-center py-8 text-red-400">שגיאה בטעינת היסטוריית בדיקות מחירים</div>`;
                return;
            }
            const invoices = data.data.invoices || [];
            if (invoices.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-slate-400">אין בדיקות מחירים קודמות</div>';
                return;
            }
            container.innerHTML = invoices.map(inv => `
                <div class="bg-dark-lighter/80 border border-slate-700/60 rounded-xl p-4 shadow-lg">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-white">${escapeHtml(inv.make || '')} ${escapeHtml(inv.model || '')} ${escapeHtml(String(inv.year || ''))}</h3>
                            <div class="text-sm text-slate-400 mt-1">
                                ${new Date(inv.created_at).toLocaleDateString('he-IL')} ·
                                ${inv.total_price_ils ? '₪' + inv.total_price_ils.toLocaleString() : 'לא צוין סכום'}
                            </div>
                        </div>
                        <a href="/api/service-prices/download/${inv.id}" class="text-primary hover:underline text-sm">הורד דוח</a>
                    </div>
                </div>
            `).join('');
        } catch (err) {
            container.innerHTML = '<div class="text-center py-8 text-red-400">שגיאה בטעינת היסטוריית בדיקות מחירים</div>';
        }
    }

    async function loadComparisonsHistory() {
        const container = document.getElementById('comparisons-list');
        try {
            const response = await fetch('/api/compare/history?limit=20', {
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.ok) {
                container.innerHTML = `<div class="text-center py-8 text-red-400">${escapeHtml(data.message || 'שגיאה בטעינת היסטוריית השוואות')}</div>`;
                return;
            }
            
            const history = data.data?.history || [];
            comparisonsLoaded = true;
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-dark-lighter/40 rounded-2xl border border-slate-800">
                        <p class="text-slate-400 mb-4">אין היסטוריית השוואות עדיין.</p>
                        <a href="/compare" class="px-6 py-2 rounded-full bg-primary text-white font-bold text-sm">
                            התחל השוואה
                        </a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = history.map(item => {
                const cars = item.cars || [];
                const carsDisplay = cars.map(c => `${c.make} ${c.model}`).join(' vs ');
                const winner = item.overall_winner;
                const date = new Date(item.created_at).toLocaleDateString('he-IL', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                return `
                    <article class="bg-dark-lighter/80 border border-slate-700/60 rounded-xl p-4 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                    ${escapeHtml(carsDisplay)}
                                </h3>
                                <div class="flex flex-wrap items-center gap-2 mt-1 text-[11px] text-slate-400">
                                    <span>${escapeHtml(date)}</span>
                                    ${winner ? `<span>•</span><span class="text-emerald-300">מנצח: ${escapeHtml(winner)}</span>` : ''}
                                </div>
                            </div>
                            <a href="/compare?load=${item.id}" 
                               class="px-3 py-1.5 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-colors">
                                צפה בפרטים
                            </a>
                        </div>
                    </article>
                `;
            }).join('');
            
        } catch (err) {
            console.error('[DASHBOARD] Failed to load comparisons:', err);
            container.innerHTML = '<div class="text-center py-8 text-red-400">שגיאה בטעינת היסטוריית השוואות</div>';
        }
    }

</script>

{% include "_footer.html" %}

</body>
</html>
