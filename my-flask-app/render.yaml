services:
  - type: web
    name: my-flask-app
    env: python
    plan: free
    buildCommand: pip install -r requirements.txt
    preDeployCommand: flask --app main:create_app db upgrade && flask --app main:create_app db current && python -c "import os; from sqlalchemy import create_engine, inspect; url = os.environ.get('DATABASE_URL') or os.environ.get('SQLALCHEMY_DATABASE_URI'); assert url, 'DATABASE_URL missing'; eng = create_engine(url); insp = inspect(eng); assert insp.has_table('legal_acceptance'), 'legal_acceptance table missing after db upgrade'; print('OK: legal_acceptance exists')"
    startCommand: flask --app main:create_app db upgrade && flask --app main:create_app db current && gunicorn "main:create_app()" --bind 0.0.0.0:$PORT --timeout 180 --graceful-timeout 30 --keep-alive 5 --workers 2
    autoDeploy: true
    envVars:
      - key: FLASK_APP
        value: main:create_app
